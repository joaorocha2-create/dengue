<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mapa Interativo — Focos da Dengue em Goiás</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<style>
  html, body, #map { height: 100%; margin: 0; }
  body { font-family: Arial, sans-serif; }
  header { background: #2b6cb0; color: white; padding: 12px; text-align: center; font-size: 20px; position: relative; }

  /* Botões superiores */
  .top-buttons {
    position: absolute;
    top: 10px;
    right: 15px;
    display: flex;
    gap: 10px;
    z-index: 1001;
  }

  .top-buttons button {
    background: #2b6cb0;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  }

  .legend { position: absolute; bottom: 20px; left: 20px; background: white; padding: 10px; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); font-size: 14px; z-index: 1000; }
  .legend div { margin-bottom: 5px; display: flex; align-items: center; }
  .legend span { display: inline-block; width: 20px; height: 20px; margin-right: 5px; }

  .denuncia { position: absolute; top: 80px; right: 20px; background: white; padding: 10px; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); width: 250px; font-size: 14px; z-index: 1000; overflow-y: auto; max-height: 300px; }
  .popup-form { display: flex; flex-direction: column; gap: 5px; }
  .popup-form input, .popup-form select, .popup-form textarea, .popup-form button { padding: 5px; font-size: 12px; }
</style>
</head>
<body>
<header>
  Mapa Interativo — Focos da Dengue em Goiás
  <div class="top-buttons">
    <button onclick="window.location.href='index.html'">Voltar</button>
    <button id="adminToggle">Acessar como adm</button>
  </div>
</header>

<div id="map"></div>
<div class="legend">
  <div><span style="background:#00ff00"></span> Baixa</div>
  <div><span style="background:#ffff00"></span> Média</div>
  <div><span style="background:#ff0000"></span> Alta</div>
</div>
<div class="denuncia">
  <strong>Denúncias no Mapa:</strong>
  <ul id="lista-denuncias" style="padding-left: 15px; margin-top: 5px;"></ul>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script>
const ADMIN_PASS = "1234"; // troque a senha
let isAdmin = false;

const map = L.map('map').setView([-16.64, -49.26], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '© OpenStreetMap'
}).addTo(map);

const drawnItems = new L.FeatureGroup().addTo(map);
const listaDenuncias = document.getElementById('lista-denuncias');

function getColor(level){
  switch(level){
    case 'baixa': return '#00ff00';
    case 'média': return '#ffff00';
    case 'alta': return '#ff0000';
    default: return '#808080';
  }
}

function atualizarListaDenuncias(){
  listaDenuncias.innerHTML = '';
  drawnItems.eachLayer(layer => {
    if(layer.options.info){
      const li = document.createElement('li');
      li.textContent = `Data: ${layer.options.info.data}, Nível: ${layer.options.info.nivel}, Motivo: ${layer.options.info.motivo}`;
      listaDenuncias.appendChild(li);
    }
  });
}

const drawControl = new L.Control.Draw({
  edit: { featureGroup: drawnItems },
  draw: { marker:false, polyline:false, circle:false, circlemarker:false, rectangle:true, polygon:true }
});

// Funções de modo visualização e admin
function enableViewMode() {
  removeDrawControl();
  document.getElementById('adminToggle').textContent = 'Acessar como adm';
  isAdmin = false;
}

function enableAdminMode() {
  map.addControl(drawControl);
  document.getElementById('adminToggle').textContent = 'Sair do modo adm';
  isAdmin = true;
}

function removeDrawControl() {
  const controls = document.querySelectorAll('.leaflet-control-draw');
  controls.forEach(el => el.remove());
}

// Ao clicar no botão admin
document.getElementById('adminToggle').addEventListener('click', () => {
  if (!isAdmin) {
    const pass = prompt("Digite a senha de administrador:");
    if (pass === ADMIN_PASS) {
      enableAdminMode();
      alert("Modo administrador ativado!");
    } else if (pass !== null) {
      alert("Senha incorreta!");
    }
  } else {
    enableViewMode();
    alert("Saindo do modo administrador.");
  }
});

// Evento de criação (somente quando admin)
map.on(L.Draw.Event.CREATED, function(e){
  if (!isAdmin) return;

  const layer = e.layer;
  const formHtml = `<div class='popup-form'>
    <label>Nível do Foco:</label>
    <select id='nivel'>
      <option value='baixa'>Baixa</option>
      <option value='média'>Média</option>
      <option value='alta'>Alta</option>
    </select>
    <label>Motivo:</label>
    <textarea id='motivo' rows='2' placeholder='Informe o motivo'></textarea>
    <label>Data:</label>
    <input type='date' id='data' value='${new Date().toISOString().slice(0,10)}'>
    <button id='salvar'>Salvar</button>
  </div>`;

  layer.bindPopup(formHtml).openPopup();
  drawnItems.addLayer(layer);

  layer.on('popupopen', function(){
    document.getElementById('salvar').onclick = function(){
      const nivel = document.getElementById('nivel').value;
      const motivo = document.getElementById('motivo').value || 'Sem descrição';
      const data = document.getElementById('data').value;
      layer.setStyle({ color: getColor(nivel), fillOpacity: 0.5 });
      layer.options.info = { nivel, motivo, data };
      atualizarListaDenuncias();
      layer.bindPopup(`<strong>Foco da Dengue</strong><br>Data: ${data}<br>Nível: ${nivel}<br>Motivo: ${motivo}<br><br><a href='mailto:julio.oliveira1@estudante.ifgoiano.edu.br?subject=Denúncia Foco Dengue&body=Data:${data}%0ANível:${nivel}%0AMotivo:${encodeURIComponent(motivo)}' target='_blank'>Enviar por e-mail</a>`).openPopup();
    };
  });
});

// Começa no modo visualização
enableViewMode();
</script>
</body>
</html>
